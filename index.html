<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIAR'S BAR - Manager (Individual Guns)</title>
    <style>
        /* --- CSS Variables & Reset --- */
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #2c241b; /* Dark Wood */
            --accent-red: #8a0e0e;
            --accent-gold: #c5a059;
            --text-color: #e0dacc;
            --font-main: 'Courier New', Courier, monospace;
            --status-connected: #4caf50;
            --status-disconnected: #f44336;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            background-image: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
        }

        /* --- Container & Layout --- */
        #app {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        #ble-indicator {
            position: absolute;
            top: 25px;
            right: 25px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--status-disconnected);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: background-color 0.3s;
            z-index: 10;
        }
        #ble-indicator.connected {
            background-color: var(--status-connected);
            box-shadow: 0 0 8px var(--status-connected);
        }

        h1 {
            text-align: center;
            color: var(--accent-gold);
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px #000;
            letter-spacing: 2px;
            border-bottom: 2px solid var(--accent-red);
            padding-bottom: 10px;
        }

        /* --- Panels --- */
        .panel {
            background: var(--panel-color);
            border: 2px solid #3e3226;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* --- Buttons --- */
        button {
            background: #3e3226;
            color: var(--accent-gold);
            border: 2px solid var(--accent-gold);
            padding: 10px 20px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        button:active {
            transform: scale(0.98);
            background: var(--accent-gold);
            color: #000;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .btn-large {
            width: 100%;
            font-size: 1.2rem;
            padding: 15px;
            margin-top: 10px;
        }

        .btn-danger {
            background-color: var(--accent-red);
            color: white;
            border-color: #ff4444;
            font-size: 1.5rem;
            letter-spacing: 3px;
        }
        
        .btn-ble {
            border-color: #4a90e2;
            color: #4a90e2;
            font-size: 0.9rem;
            margin-top: 20px;
            width: 100%;
        }
        .btn-ble.connected {
            background-color: #4a90e2;
            color: white;
        }

        /* --- Game Screen Elements --- */
        #table-card-display {
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: var(--accent-gold);
            padding: 20px;
            border: 3px double var(--accent-gold);
            margin-bottom: 10px;
            background: #000;
            animation: fadeIn 0.5s;
        }

        .card-label {
            font-size: 1rem;
            color: #888;
            display: block;
            margin-bottom: 5px;
            text-align: center;
        }

        /* Gun Control */
        .gun-control {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Cylinder Visual */
        .cylinder-status {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
        }
        .chamber {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            border: 2px solid #111;
            transition: all 0.3s;
        }
        .chamber.active {
            background: var(--accent-gold);
            box-shadow: 0 0 8px var(--accent-gold);
            border-color: #fff;
            transform: scale(1.2);
        }

        select {
            width: 100%;
            padding: 15px;
            background: #000;
            color: var(--text-color);
            border: 1px solid var(--accent-gold);
            font-family: inherit;
            font-size: 1.2rem;
            margin-bottom: 5px;
            text-align: center;
        }

        /* Player List */
        .player-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .player-card {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border: 1px solid #555;
            text-align: center;
            position: relative;
        }
        .player-card.dead {
            opacity: 0.4;
            text-decoration: line-through;
            border-color: var(--accent-red);
            background: rgba(50, 0, 0, 0.3);
        }
        .player-card.dead::after {
            content: "DEAD";
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            color: var(--accent-red);
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid var(--accent-red);
            padding: 2px 5px;
            text-decoration: none;
        }

        /* Log & Settings */
        #game-log {
            height: 100px;
            overflow-y: auto;
            background: #000;
            border: 1px solid #444;
            padding: 10px;
            font-size: 0.9rem;
            color: #aaa;
            font-family: monospace;
            margin-top: 10px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #333; padding-bottom: 2px; }
        .log-bang { color: var(--accent-red); font-weight: bold; }
        .log-click { color: #88cc88; }
        .log-info { color: var(--accent-gold); }
        .log-sys  { color: #4a90e2; }

        .settings {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }
        input[type="range"] { accent-color: var(--accent-gold); }

        /* Setup Screen */
        .setup-group {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .setup-group label {
            display: flex; align-items: center; gap: 5px; font-size: 1.2rem; cursor: pointer;
        }

        .hidden { display: none !important; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .screen-shake { animation: shake 0.5s; }

    </style>
</head>
<body>

<div id="app">
    <div id="ble-indicator" title="Controller Status"></div>
    <h1>LIAR'S BAR</h1>

    <!-- SETUP SCREEN -->
    <div id="screen-setup" class="panel">
        <h2 style="text-align: center; color: var(--accent-gold);">SETUP</h2>
        <p style="text-align: center;">プレイヤー人数を選択</p>
        <div class="setup-group">
            <label><input type="radio" name="playerCount" value="2" checked> 2人</label>
            <label><input type="radio" name="playerCount" value="3"> 3人</label>
            <label><input type="radio" name="playerCount" value="4"> 4人</label>
        </div>
        
        <button id="btn-connect-ble" class="btn-ble" onclick="bleManager.connect()">CONNECT GUN CONTROLLER</button>
        <button class="btn-large" onclick="game.startSetup()">GAME START</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="panel hidden">
        <div>
            <span class="card-label">CURRENT TABLE</span>
            <div id="table-card-display">?</div>
        </div>

        <div class="gun-control panel" style="border-color: var(--accent-red);">
            <!-- Cylinder Visual is now linked to the selected player -->
            <div class="cylinder-status" id="cylinder-visual"></div>
            
            <label class="card-label">WHO PULLS THE TRIGGER?</label>
            <select id="target-player-select" onchange="game.onPlayerSelectChange()"></select>
            
            <button id="btn-trigger" class="btn-large btn-danger" onclick="game.pullTrigger()">TRIGGER</button>
        </div>

        <div id="player-list-container" class="player-list"></div>

        <button id="btn-next-round" class="btn-large" onclick="game.nextRound()">NEXT ROUND (New Table)</button>

        <div id="game-log"></div>

        <div class="settings">
            <span>Sound Volume</span>
            <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.5">
        </div>
    </div>
</div>

<script>
    /**
     * LIAR'S BAR GAME MANAGER
     * Update: プレイヤーごとに独立した銃を持つ仕様へ変更
     */
    
    // --- Audio System ---
    const SOUNDS = {
        click: new Audio('sounds/shoot-blank.mp3'),
        bang: new Audio('sounds/shoot-live.mp3')
    };
    Object.values(SOUNDS).forEach(audio => {
        audio.onerror = () => console.warn("Audio file missing.");
    });

    const CARDS = ['QUEEN', 'KING', 'ACE'];

    // --- BLE Manager ---
    class BLEManager {
        constructor() {
            this.device = null;
            this.characteristic = null;
            this.SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
            this.CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        }

        async connect() {
            try {
                game.log("Requesting BLE Device...", "log-sys");
                this.device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [this.SERVICE_UUID] }]
                });

                this.device.addEventListener('gattserverdisconnected', this.onDisconnected.bind(this));
                const server = await this.device.gatt.connect();
                const service = await server.getPrimaryService(this.SERVICE_UUID);
                this.characteristic = await service.getCharacteristic(this.CHARACTERISTIC_UUID);
                await this.characteristic.startNotifications();
                this.characteristic.addEventListener('characteristicvaluechanged', this.handleNotifications.bind(this));

                this.updateStatus(true);
                game.log("Controller Connected!", "log-sys");
                
                const btn = document.getElementById('btn-connect-ble');
                btn.textContent = "CONTROLLER CONNECTED";
                btn.classList.add('connected');
                btn.disabled = true;

            } catch (error) {
                console.error("BLE Error:", error);
                game.log(`BLE Connect Failed: ${error.name}`, "log-sys");
            }
        }

        onDisconnected() {
            this.updateStatus(false);
            game.log("Controller Disconnected.", "log-sys");
            const btn = document.getElementById('btn-connect-ble');
            btn.textContent = "RECONNECT GUN CONTROLLER";
            btn.classList.remove('connected');
            btn.disabled = false;
            this.characteristic = null;
        }

        handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const command = decoder.decode(value);
            if (command === 'fire') {
                const triggerBtn = document.getElementById('btn-trigger');
                if (!triggerBtn.disabled && !game.isGameOver) {
                    game.pullTrigger();
                }
            }
        }

        updateStatus(isConnected) {
            const indicator = document.getElementById('ble-indicator');
            if (isConnected) indicator.classList.add('connected');
            else indicator.classList.remove('connected');
        }
    }
    const bleManager = new BLEManager();


    // --- Game Logic ---
    class LiarsBarGame {
        constructor() {
            this.players = [];
            this.isGameOver = false;
        }

        init(playerCount) {
            this.players = [];
            for (let i = 1; i <= playerCount; i++) {
                // プレイヤーごとに銃の状態を持たせる
                // bulletPos: 0-5 (実弾の位置), chamberPos: 0-5 (現在のシリンダー位置)
                const p = { 
                    id: i, 
                    name: `Player ${i}`, 
                    alive: true,
                    bulletPos: 0,
                    chamberPos: 0
                };
                this.resetPlayerGun(p); // 個別に初期化
                this.players.push(p);
            }
            this.isGameOver = false;
            
            this.updateUI();
            this.log("GAME STARTED. Guns distributed.");
            this.nextRound();
        }

        // 指定プレイヤーの銃をリセット（ランダム装填）
        resetPlayerGun(player) {
            player.bulletPos = Math.floor(Math.random() * 6);
            player.chamberPos = 0;
            // ログには詳細を出さず、リセットされたことだけ示す
            // console.log(`${player.name} Gun: Bullet at ${player.bulletPos}`);
        }

        nextRound() {
            if (this.checkWinner()) return;

            const card = CARDS[Math.floor(Math.random() * CARDS.length)];
            const display = document.getElementById('table-card-display');
            display.style.opacity = 0;
            setTimeout(() => {
                display.innerText = card;
                display.style.opacity = 1;
                if (card === 'QUEEN') display.style.color = '#e91e63'; 
                if (card === 'KING') display.style.color = '#c5a059'; 
                if (card === 'ACE') display.style.color = '#fff';     
            }, 200);

            this.log(`New Table: ${card}`, 'log-info');
        }

        // プルダウン変更時のハンドラ
        onPlayerSelectChange() {
            this.renderCylinder(); // 選択されたプレイヤーのシリンダーを表示
        }

        pullTrigger() {
            if (this.isGameOver) return;

            const select = document.getElementById('target-player-select');
            const playerId = parseInt(select.value);
            const playerIndex = this.players.findIndex(p => p.id === playerId);
            const player = this.players[playerIndex];
            
            if (!player || !player.alive) return;

            const btn = document.getElementById('btn-trigger');
            btn.disabled = true;
            document.body.classList.add('screen-shake');

            // 判定：対象プレイヤーの銃の状態を確認
            const isLiveRound = (player.chamberPos === player.bulletPos);

            if (isLiveRound) {
                // BANG
                this.playSound('bang');
                this.log(`BANG!!! ${player.name} is ELIMINATED.`, 'log-bang');
                player.alive = false;
                // 死亡したプレイヤーの銃をリセットする必要はないが、
                // もし復活ルールがあるならここで resetPlayerGun(player)
            } else {
                // CLICK
                this.playSound('click');
                this.log(`${player.name}: Click... (Blank).`, 'log-click');
                // そのプレイヤーのシリンダーだけ進める
                player.chamberPos = (player.chamberPos + 1) % 6;
            }

            setTimeout(() => document.body.classList.remove('screen-shake'), 500);

            this.renderCylinder(); // 更新後のシリンダーを表示
            this.updatePlayerList(); 
            this.updateSelectOptions(); 

            setTimeout(() => {
                if(!this.checkWinner()) {
                    btn.disabled = false;
                }
            }, 1000);
        }

        checkWinner() {
            const survivors = this.players.filter(p => p.alive);
            if (survivors.length <= 1) {
                const winner = survivors[0];
                const display = document.getElementById('table-card-display');
                display.innerText = `${winner.name} WINS!`;
                display.style.color = 'var(--accent-red)';
                this.log(`GAME OVER. Winner: ${winner.name}`, 'log-info');
                this.isGameOver = true;
                document.getElementById('btn-trigger').disabled = true;
                document.getElementById('btn-next-round').innerText = "RESTART GAME";
                document.getElementById('btn-next-round').onclick = () => location.reload();
                return true;
            }
            return false;
        }

        // --- UI Rendering ---

        updateUI() {
            this.updatePlayerList();
            this.updateSelectOptions();
            this.renderCylinder(); // 初期選択プレイヤーのシリンダーを表示
        }

        updatePlayerList() {
            const container = document.getElementById('player-list-container');
            container.innerHTML = '';
            this.players.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-card ${p.alive ? '' : 'dead'}`;
                div.innerText = p.name;
                container.appendChild(div);
            });
        }

        updateSelectOptions() {
            const select = document.getElementById('target-player-select');
            const currentVal = select.value;
            select.innerHTML = '';
            
            // 生存者のみを選択肢に
            this.players.filter(p => p.alive).forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.innerText = p.name;
                select.appendChild(opt);
            });

            // 以前の選択を維持しようと試みる
            if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
                select.value = currentVal;
            } else {
                // 選択が変わった（死んだ等）場合、先頭を選択してシリンダー更新
                if(select.options.length > 0) select.selectedIndex = 0;
            }
            this.renderCylinder();
        }

        // 選択中のプレイヤーのシリンダー状態を描画
        renderCylinder() {
            const container = document.getElementById('cylinder-visual');
            container.innerHTML = '';

            const select = document.getElementById('target-player-select');
            if(!select.value) return; // 誰もいない場合

            const playerId = parseInt(select.value);
            const player = this.players.find(p => p.id === playerId);

            if(!player) return;

            // プレイヤーの chamberPos に基づいて描画
            for(let i=0; i<6; i++) {
                const chamber = document.createElement('div');
                chamber.className = `chamber ${i === player.chamberPos ? 'active' : ''}`;
                container.appendChild(chamber);
            }
        }

        log(msg, className = '') {
            const logDiv = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;
            entry.innerText = `> ${msg}`;
            logDiv.prepend(entry);
        }

        playSound(type) {
            const vol = document.getElementById('volume-control').value;
            if (SOUNDS[type]) {
                SOUNDS[type].volume = vol;
                SOUNDS[type].currentTime = 0;
                SOUNDS[type].play().catch(e => {});
            }
        }

        startSetup() {
            const radios = document.getElementsByName('playerCount');
            let count = 2;
            for (const r of radios) if (r.checked) count = parseInt(r.value);
            
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            this.init(count);
        }
    }

    const game = new LiarsBarGame();

    // Volume Listener
    document.getElementById('volume-control').addEventListener('input', (e) => {
        // No action needed
    });

</script>
</body>
</html>
